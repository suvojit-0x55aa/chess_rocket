## Codebase Patterns
- Python 3.10+ required
- python-chess library for chess logic (Board, Move, etc.)
- Stockfish minimum UCI_Elo is 1320 - use depth limiting + random moves below that
- MCP server uses FastMCP from mcp.server.fastmcp
- TUI syncs via data/current_game.json file polling at 4Hz
- SRS uses SM-2 algorithm
- All user data stored in data/ directory
- Progress state in data/progress.json
- Use `uv run python` to execute scripts (system python3 lacks project deps)
- mcp-server/ has hyphen in name - use importlib.util for imports in tests, not regular `from mcp_server import`
- Atomic file writes: always use temp file + os.replace() pattern for data persistence
- PGN auto-saves on game over in make_move/engine_move (fire-and-forget)
- progress.json uses both `current_elo` and `estimated_elo` keys for forward compat
- Tests with real Stockfish: use `_clean_data` fixture to backup/restore data files
---

# Ralph Progress Log
Started: 2026-02-06
---

## 2026-02-06 - US-008: Create Curriculum and Pedagogy Reference Files
- Created references/curriculum.md: 3-phase curriculum (Foundation 0-600, Tactical Basics 600-1000, Intermediate 1000-1500)
  - Each phase includes 6-7 detailed lessons with learning objectives and prerequisites
  - Lessons cover foundational concepts through advanced strategic planning
  - Cross-references with pedagogy and learning science documentation
  
- Created references/chess-pedagogy.md: GM coaching methodology
  - 7 major sections: Socratic Method, Pattern Recognition, Deliberate Practice, Error Analysis, Progressive Complexity, Teaching by Elo, Growth Mindset
  - Practical examples for each teaching technique
  - Language adaptation guidelines for different Elo ranges
  - Integration with Speedrun system architecture
  
- Created references/learning-science.md: Cognitive science foundations
  - 9 major sections grounded in research (Ericsson, Vygotsky, Ebbinghaus, Sweller, Dweck, etc.)
  - Explains why each pedagogy technique is effective
  - Practical application to chess learning
  - Integration section showing how principles work together
  
- Created references/elo-milestones.md: Skills and expectations by Elo range
  - 3 detailed Elo ranges with concrete skills, common mistakes, readiness indicators
  - Cross-level pattern tables showing progression
  - Teaching guidance for assessing level and setting goals
  - Links to pedagogy and curriculum for appropriate interventions

**Files changed:**
- Created: /references/curriculum.md (396 lines)
- Created: /references/chess-pedagogy.md (456 lines)
- Created: /references/learning-science.md (470 lines)
- Created: /references/elo-milestones.md (462 lines)

**Learnings for future iterations:**
- Curriculum structure uses 3 phases aligned to Elo ranges (0-600, 600-1000, 1000-1500)
- Each phase needs 6-7 lessons for comprehensive coverage without overwhelming learners
- Pedagogy references specific teaching techniques: Socratic method, pattern recognition, deliberate practice
- Learning science grounding is critical for tutor justifying recommendations
- Cross-references between files create interconnected knowledge base (used by SKILL.md in US-011)
- Elo milestones provide clear expectations for what players at each level should achieve
- Teaching language must adapt based on Elo: concrete (0-600), principle-based (600-1000), strategic (1000-1500)
---

## 2026-02-06 - US-009: Create Tactical Patterns and Mistakes Reference Files
- Files already existed (created alongside US-008) but were untracked - committed them
- references/tactical-patterns.md: 7 tactical patterns (forks x3, pins x2, skewers, discovered attacks, discovered check, double check, back-rank threats)
- references/common-mistakes.md: 9 common mistakes with severity classification (hanging pieces, ignoring threats, premature queen, not castling, same piece twice, no center control, trading when behind, neglecting development, not looking for checks)
- references/opening-guide.md: 4 beginner-friendly openings (Italian Game, London System, Sicilian Defense, Scandinavian Defense)

**Files changed:**
- Committed: references/tactical-patterns.md
- Committed: references/common-mistakes.md
- Committed: references/opening-guide.md

**Learnings for future iterations:**
- US-008 iteration created US-009 files too - always check git status for untracked files from previous iterations
- Reference files cross-reference each other (tactical-patterns.md referenced from opening-guide.md)
- All reference files are now in place for SKILL.md (US-011) to reference
---

## 2026-02-06 - US-010: Create Curated Puzzle Sets with FEN Validation
- All 6 puzzle JSON files already existed from a previous iteration (untracked)
- Validated all 69 puzzles across 6 files using scripts/validate_puzzles.py
- All FENs load in python-chess, all solution_moves are legal in sequence
- Committed all puzzle files and validator script

**Files changed:**
- Committed: puzzles/forks.json (12 puzzles)
- Committed: puzzles/pins.json (12 puzzles)
- Committed: puzzles/skewers.json (11 puzzles)
- Committed: puzzles/back-rank.json (12 puzzles)
- Committed: puzzles/checkmate-patterns.json (11 puzzles)
- Committed: puzzles/beginner-endgames.json (11 puzzles)
- Committed: scripts/validate_puzzles.py

**Learnings for future iterations:**
- Puzzle files and validator were created in earlier iterations but left untracked - always check git status
- Use `uv run python` to execute scripts (system python3 lacks chess module)
- validate_puzzles.py checks: FEN validity, UCI move parsing, sequential move legality
- Each puzzle requires: fen, solution_moves (UCI), solution_san, motif, difficulty, explanation
---

## 2026-02-06 - US-013: Create Claude Settings and Run Integration Verification
- Verified .claude/settings.json exists with correct MCP server config (command: python, args: [mcp-server/server.py])
- Ran py_compile on all 8 Python files (7 in scripts/, 1 in mcp-server/) - all pass
- Ran validate_puzzles.py - all 69 puzzles across 6 files valid
- Verified all 8 required directories exist: data/sessions, data/games, data/lesson_plans, references/, puzzles/, mcp-server/, scripts/, .claude/
- Verified all 10 required files exist: install.sh, engine.py, srs.py, tui.py, export.py, models.py, validate_puzzles.py, server.py, SKILL.md, settings.json
- Committed remaining untracked project files: scripts/__init__.py, scripts/models.py, scripts/install.sh, documentation/, uv.lock

**Files changed:**
- Verified: .claude/settings.json (already had correct MCP config)
- Updated: prd.json (US-013 passes: true)
- Committed untracked: scripts/__init__.py, scripts/models.py, scripts/install.sh, documentation/, uv.lock

**Learnings for future iterations:**
- .claude/settings.json was created by earlier iterations - always check if it exists before creating
- Integration verification is about running ALL checks, not writing new code
- Some files created in US-001 (models.py, __init__.py, install.sh) may remain untracked through many iterations - final story catches these
- chess-openings/ directory is external data, not part of the project structure
---

## 2026-02-06 - US-014: Auto-save PGN on game over
- Added `_auto_save_pgn(game_id, game)` helper to mcp-server/server.py
- Builds PGN with Event/Site/Date/White/Black Elo headers using chess.pgn.Game
- Reads player Elo from data/progress.json for PGN header
- Writes atomically to data/games/game_{timestamp}_{game_id[:8]}.pgn
- Hooked into make_move() and engine_move() after board.push() when board.is_game_over()
- Files changed: mcp-server/server.py
- **Learnings for future iterations:**
  - datetime import needed: `from datetime import datetime, timezone`
  - PGN setup from non-standard FEN: use `pgn_game.setup(chess.Board(fen))`
  - Fire-and-forget pattern: auto-save does not affect return value of make_move/engine_move
---

## 2026-02-06 - US-015: Add save_session MCP tool
- New @mcp.tool() save_session() in mcp-server/server.py
- Loads/updates data/progress.json: increments sessions_completed, total_games, streak, appends accuracy
- Writes both current_elo and estimated_elo for forward compatibility
- Writes session log to data/sessions/session_NNN.json with full game metadata
- All writes use atomic temp file + os.replace() pattern
- Files changed: mcp-server/server.py
- **Learnings for future iterations:**
  - progress.json defaults must include all keys for backward compat
  - Session numbering is zero-padded 3 digits: session_001.json
---

## 2026-02-06 - US-016: Add create_srs_cards_from_game MCP tool
- New @mcp.tool() create_srs_cards_from_game() in mcp-server/server.py
- Replays game from starting_fen, evaluates each player move at depth 20
- Creates SRS cards for moves with cp_loss >= threshold (default 80)
- Uses fresh ChessEngine at full strength (3000) for analysis, closes when done
- Files changed: mcp-server/server.py
- **Learnings for future iterations:**
  - Must determine player moves by checking board.turn vs player_color
  - evaluate_move() must be called BEFORE board.push() (it needs the pre-move position)
  - Always close analysis engine in finally block to prevent Stockfish process leaks
---

## 2026-02-06 - US-017: Fix export.py estimated_elo key mismatch
- One-line fix: progress.get('estimated_elo', progress.get('current_elo', 'Unknown'))
- Files changed: scripts/export.py
- **Learnings for future iterations:**
  - progress.json may have either key name depending on which tool wrote it
  - Always use fallback chain for backward compatibility with data files
---

## 2026-02-06 - US-018: Update CLAUDE.md and SKILL.md for post-game automation
- CLAUDE.md: Updated Post-Game Flow (PGN auto-saved, create_srs_cards_from_game)
- CLAUDE.md: Updated Session End Flow (save_session tool replaces manual writes)
- CLAUDE.md: Added save_session and create_srs_cards_from_game to MCP Tools table
- SKILL.md: Updated sections 7, 8, and 13 to reference new automated tools
- Files changed: CLAUDE.md, SKILL.md
- **Learnings for future iterations:**
  - Keep MCP tool count in SKILL.md section 13 updated when adding tools (now 15)
---

## 2026-02-06 - US-019: End-to-end post-game flow integration test
- Created tests/test_post_game.py with 9 pytest tests using real Stockfish
- Tests cover: auto PGN save, save_session, create_srs_cards_from_game, export_progress
- Uses importlib.util to import from hyphenated mcp-server/ directory
- _clean_data fixture backs up and restores data files around each test
- All 42 tests pass (33 existing + 9 new) in ~7.5s
- Files changed: tests/test_post_game.py (new)
- **Learnings for future iterations:**
  - mcp-server/ directory has hyphen: cannot use normal Python import, use importlib.util
  - set_position with a near-mate FEN is the fastest way to test game completion
  - Scholar's mate position (Qxf7#) is ideal for tests: one move to checkmate
---
