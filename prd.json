{
  "project": "Chess Speedrun Learning System",
  "branchName": "ralph/chess-speedrun-v1",
  "description": "An adaptive chess tutor system using Claude Code + Stockfish + MCP server + TUI",
  "documentationRef": "documentation/general_chess_speedrun_prd_documentation.md",
  "userStories": [
    {
      "id": "US-001",
      "title": "Create install script and project structure",
      "description": "As a developer, I need the install script, shared data models, and directory structure so the project can be set up.",
      "acceptanceCriteria": [
        "scripts/install.sh exists and is executable",
        "Installs Stockfish via brew (macOS) or apt (Linux); skips if already installed",
        "Installs uv if not present, uses uv for environment management",
        "Installs Python deps via uv: python-chess, rich, textual, watchdog, mcp[cli]",
        "Creates data directories: data/sessions, data/games, data/lesson_plans",
        "Creates data/.gitkeep files in each data subdirectory",
        "Initializes data/progress.json with default values if not exists",
        "Initializes data/srs_cards.json as empty array if not exists",
        "Creates pyproject.toml with project metadata, dependencies (python-chess, rich, textual, watchdog, mcp[cli]), and dev deps (pytest)",
        "scripts/models.py exists with GameState and MoveEvaluation dataclasses",
        "GameState fields: game_id, fen, board_display, move_list, last_move, last_move_san, eval_score, player_color, target_elo, is_game_over, result, legal_moves, accuracy, session_number, streak, lesson_name",
        "MoveEvaluation fields: move_san, best_move_san, cp_loss, eval_before, eval_after, classification, is_best, best_line, tactical_motif",
        "python -m py_compile scripts/models.py passes",
        "python -c \"from scripts.models import GameState, MoveEvaluation\" passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Uses uv (not pip/venv) for environment management. models.py is the shared schema for MCP server and TUI."
    },
    {
      "id": "US-002",
      "title": "Implement Stockfish engine wrapper",
      "description": "As a developer, I need a Python wrapper around Stockfish for game play and analysis with adaptive difficulty.",
      "acceptanceCriteria": [
        "scripts/engine.py exists with ChessEngine class",
        "Auto-detects Stockfish binary path (checks /usr/local/bin/stockfish, /usr/bin/stockfish, /opt/homebrew/bin/stockfish, which stockfish)",
        "Raises FileNotFoundError with 'Run scripts/install.sh' message if Stockfish not found",
        "new_game() starts a game with configurable target Elo and player_color",
        "set_difficulty() configures engine strength",
        "Sub-1320 Elo uses linear blend: random_pct = max(0, 0.85 - (elo/1320)*0.85), depth = max(1, min(5, elo//250))",
        "get_engine_move() returns moves at configured difficulty",
        "analyze_position() runs full-strength analysis with multipv support",
        "evaluate_move() compares player move to best move, returns MoveEvaluation from scripts.models",
        "Move classification: 0cp=best, 1-30=great, 31-80=good, 81-150=inaccuracy, 151-300=mistake, 300+=blunder",
        "tactical_motif field set to None (future enhancement)",
        "CLI: python scripts/engine.py analyze <fen> prints top 3 lines",
        "CLI: python scripts/engine.py play <elo> plays one engine move and exits",
        "CLI: python scripts/engine.py play <elo> --interactive runs full game loop",
        "python -m py_compile scripts/engine.py passes",
        "python -c \"from scripts.engine import ChessEngine\" passes",
        "tests/test_engine.py exists with pytest tests",
        "python -m pytest tests/test_engine.py passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Core dependency - MCP server depends on this. Tests should mock Stockfish for unit tests. Catches EngineTerminatedError and attempts one restart."
    },
    {
      "id": "US-003",
      "title": "Implement SRS spaced repetition manager",
      "description": "As a developer, I need an SRS card manager using the SM-2 algorithm for tracking chess mistakes.",
      "acceptanceCriteria": [
        "scripts/srs.py exists with SRSManager class and SM-2 algorithm",
        "CLI commands: due, review <card_id> <quality>, add (with --fen --player-move --best-move --cp-loss --classification flags), stats",
        "Cards stored in data/srs_cards.json",
        "Card schema: id(uuid), fen, player_move, best_move, cp_loss, classification, motif, explanation, created_at, next_review, interval_hours, ease_factor, repetitions, quality_history",
        "Timestamps stored as ISO 8601 strings",
        "SM-2 intervals in hours: 4, 24, 72, 168, 336, 720; after 720h multiply by ease_factor",
        "Failed cards (quality < 3) reset to interval_hours=4, repetitions=0",
        "Ease factor formula: EF' = EF + (0.1 - (5-q)*(0.08 + (5-q)*0.02)), minimum 1.3",
        "get_due_cards() returns cards where next_review <= now",
        "sm2_update() correctly updates interval, ease_factor, repetitions",
        "All CLI commands output JSON to stdout",
        "Corrupted JSON: backup file and start fresh with []",
        "python -m py_compile scripts/srs.py passes",
        "python -c \"from scripts.srs import SRSManager\" passes",
        "tests/test_srs.py exists with pytest tests for interval progression, failed reset, ease factor bounds, due filtering",
        "python -m pytest tests/test_srs.py passes"
      ],
      "priority": 3,
      "passes": false,
      "notes": "Quality scale 0-5. ValueError for quality out of range or card not found."
    },
    {
      "id": "US-004",
      "title": "MCP server - core game tools",
      "description": "As a developer, I need an MCP server with core game loop tools (new_game, get_board, make_move, engine_move).",
      "acceptanceCriteria": [
        "mcp-server/server.py exists using FastMCP from mcp.server.fastmcp",
        "mcp-server/requirements.txt lists: mcp[cli], python-chess",
        "Server name: chess-speedrun",
        "Games stored in memory dict keyed by game_id (UUID)",
        "Tool: new_game(target_elo, player_color, starting_fen) - starts game, returns GameState dict",
        "Tool: get_board(game_id) - returns current GameState dict with legal moves",
        "Tool: make_move(game_id, move) - player move in SAN notation, returns updated GameState",
        "Tool: engine_move(game_id) - engine makes move at configured difficulty, returns updated GameState",
        "After every make_move and engine_move, writes data/current_game.json using GameState from scripts.models",
        "Atomic file write: write to temp file then os.replace()",
        "Creates data/ directory if it doesn't exist on first write",
        "Invalid game_id returns error dict: {\"error\": \"Game not found: <id>\"}",
        "Illegal move returns error dict with legal moves list",
        "Move when game over returns error dict with result",
        "python -m py_compile mcp-server/server.py passes",
        "python -c \"import mcp.server.fastmcp\" passes"
      ],
      "priority": 4,
      "passes": false,
      "notes": "Imports ChessEngine from scripts.engine and GameState from scripts.models. sys.path manipulation may be needed for imports."
    },
    {
      "id": "US-005",
      "title": "MCP server - analysis tools",
      "description": "As a developer, I need analysis and evaluation tools added to the MCP server (analyze_position, evaluate_move, set_difficulty).",
      "acceptanceCriteria": [
        "Tool: analyze_position(fen, depth=20, multipv=3) added to mcp-server/server.py",
        "analyze_position works on any FEN (no active game required), creates temp ChessEngine",
        "Returns: {fen, depth, lines: [{rank, score_cp, moves, mate_in}]}",
        "Tool: evaluate_move(game_id, move) added - evaluates WITHOUT making the move",
        "Returns MoveEvaluation as dict (move_san, best_move_san, cp_loss, classification, etc.)",
        "Tool: set_difficulty(game_id, target_elo) added - changes difficulty mid-game",
        "set_difficulty clamps Elo to 100-3500 range",
        "Invalid FEN in analyze_position returns error dict",
        "evaluate_move on finished game returns error dict",
        "python -m py_compile mcp-server/server.py passes"
      ],
      "priority": 5,
      "passes": false,
      "notes": "Appends tools to existing mcp-server/server.py from US-004. Does not create new files."
    },
    {
      "id": "US-006",
      "title": "MCP server - utility tools",
      "description": "As a developer, I need utility tools added to the MCP server (PGN, legal moves, undo, set_position, SRS integration).",
      "acceptanceCriteria": [
        "Tool: get_game_pgn(game_id) added - returns valid PGN string",
        "Tool: get_legal_moves(game_id, square=None) added - lists legal moves, optionally filtered by source square",
        "Tool: undo_move(game_id) added - undoes last move; if last two were player+engine, undoes both",
        "undo_move updates data/current_game.json after undo",
        "undo_move on empty game (no moves) returns error dict",
        "Tool: set_position(fen) added - creates new game from custom FEN for puzzles, defaults to full-strength engine",
        "Tool: srs_add_card(game_id, move, explanation) added - saves current position as SRS mistake card via scripts.srs",
        "get_legal_moves on empty square returns empty list",
        "set_position with invalid FEN returns error dict",
        "PGN of game with no moves returns valid minimal PGN",
        "python -m py_compile mcp-server/server.py passes"
      ],
      "priority": 6,
      "passes": false,
      "notes": "Appends tools to existing mcp-server/server.py. srs_add_card is a bonus tool for tutor to save mistakes during games."
    },
    {
      "id": "US-007",
      "title": "Implement Terminal UI with Rich",
      "description": "As a user, I need a terminal chess board display that auto-updates during games by watching current_game.json.",
      "acceptanceCriteria": [
        "scripts/tui.py exists using Rich library",
        "Renders chess board with Unicode piece symbols (K=♔, Q=♕, R=♖, B=♗, N=♘, P=♙, etc.)",
        "Board has alternating dark/light square colors",
        "Highlights last move source/destination squares",
        "Board flips orientation if player is black",
        "Sidebar shows: move list (numbered SAN), eval bar with centipawn score, accuracy percentages",
        "Header shows: session number, streak, lesson name",
        "Layout: board on left (ratio 2), sidebar on right (ratio 1)",
        "Watches data/current_game.json using watchdog at ~4Hz (250ms interval)",
        "Graceful handling of partial/corrupt JSON writes (skip and wait for next poll)",
        "Missing current_game.json shows 'Waiting for game...' message",
        "data/sample_game.json created with a valid mid-game GameState",
        "python scripts/tui.py --sample renders sample board and exits (no watch loop)",
        "Reads GameState fields from JSON with fallback defaults for missing fields",
        "python -m py_compile scripts/tui.py passes",
        "python -c \"from scripts.tui import render_board\" passes"
      ],
      "priority": 7,
      "passes": false,
      "notes": "Standalone testing via --sample flag. No MCP dependency for testing. Imports GameState from scripts.models for type reference."
    },
    {
      "id": "US-008",
      "title": "Create curriculum and pedagogy reference files",
      "description": "As a chess tutor, I need reference materials for curriculum structure and teaching methodology.",
      "acceptanceCriteria": [
        "references/curriculum.md exists with full curriculum: Foundation (0-600), Tactical Basics (600-1000), Intermediate (1000-1500)",
        "Each phase has: lessons list, prerequisites, learning objectives",
        "references/chess-pedagogy.md exists with GM coaching methodology",
        "references/learning-science.md exists with deliberate practice and Zone of Proximal Development theory",
        "references/elo-milestones.md exists with specific skills per Elo range (at least 0-600, 600-1000, 1000-1500)",
        "Each file is well-structured with at least 3 major sections with headers",
        "Files cross-reference each other where relevant"
      ],
      "priority": 8,
      "passes": false,
      "notes": "Static content files. No code validation needed, just file existence and section structure."
    },
    {
      "id": "US-009",
      "title": "Create tactical patterns and mistakes reference files",
      "description": "As a chess tutor, I need reference materials for tactical patterns and common beginner mistakes.",
      "acceptanceCriteria": [
        "references/tactical-patterns.md exists covering: forks (knight/queen/pawn), pins (absolute/relative), skewers, discovered attacks, discovered check, double check, back-rank threats",
        "Each tactical pattern has: name, description, recognition cues, teaching approach",
        "references/common-mistakes.md exists covering: hanging pieces, ignoring threats, premature queen development, not castling, moving same piece twice, not controlling center",
        "Each mistake has: description, why beginners do it, teaching response",
        "references/opening-guide.md exists with at least 3 beginner-friendly openings with explanations",
        "Each file has well-structured sections with headers"
      ],
      "priority": 9,
      "passes": false,
      "notes": "Static content files. Must be created before SKILL.md (US-011) so it can reference them."
    },
    {
      "id": "US-010",
      "title": "Create curated puzzle sets with validation",
      "description": "As a chess tutor, I need puzzle positions organized by tactical motif with programmatic FEN validation.",
      "acceptanceCriteria": [
        "puzzles/forks.json exists with 10+ fork puzzle positions",
        "puzzles/pins.json exists with 10+ pin puzzle positions",
        "puzzles/skewers.json exists with 10+ skewer puzzle positions",
        "puzzles/back-rank.json exists with 10+ back-rank mate puzzles",
        "puzzles/checkmate-patterns.json exists with 10+ checkmate puzzles",
        "puzzles/beginner-endgames.json exists with 10+ endgame positions",
        "Each puzzle has: fen, solution_moves (UCI), solution_san, motif, difficulty, explanation",
        "scripts/validate_puzzles.py exists and validates all puzzle files",
        "Validation checks: FEN loads in python-chess without error, solution_moves are legal from position, sequential solution moves are each legal after previous",
        "python scripts/validate_puzzles.py exits with code 0",
        "python -m py_compile scripts/validate_puzzles.py passes"
      ],
      "priority": 10,
      "passes": false,
      "notes": "LLM-generated FENs are often invalid - programmatic validation is critical. Must be created before SKILL.md (US-011)."
    },
    {
      "id": "US-011",
      "title": "Create SKILL.md chess tutor skill file",
      "description": "As a Claude Code user, I need the SKILL.md file that transforms Claude Code into an adaptive chess tutor.",
      "acceptanceCriteria": [
        "SKILL.md exists with proper frontmatter (name, description, triggers: chess, play chess, chess lesson)",
        "Defines 3 expert roles: GM Teacher, Learning Psychologist, Behavioral Specialist",
        "Documents Quick Start flow: read progress, check MCP, load references, proceed",
        "Documents core loop: Play -> Analyze -> Teach -> Replay -> Plan",
        "Move evaluation thresholds: <=30 acknowledge, 31-80 mention, 81-200 teach, >200 intervene",
        "Language adaptation by Elo range (<600 simple, 600-1000 moderate, 1000-1500 technical)",
        "Post-game flow: save PGN, show summary, identify teaching positions, offer replay",
        "Session ending flow: save log, update progress, generate 3-perspective plan",
        "Difficulty control table: accuracy vs Elo offset mapping",
        "SRS system documentation with SM-2 intervals",
        "Curriculum phases summary referencing references/curriculum.md",
        "3-Perspective lesson plan framework (GM, Psychologist, Behaviorist)",
        "File references section pointing to actual files in references/, puzzles/, data/ directories"
      ],
      "priority": 11,
      "passes": false,
      "notes": "All referenced files (references/*, puzzles/*) now exist from US-008, US-009, US-010. Use relative paths."
    },
    {
      "id": "US-012",
      "title": "Create export script",
      "description": "As a developer, I need an export script for progress reports and game summaries in markdown format.",
      "acceptanceCriteria": [
        "scripts/export.py exists with export_progress() and export_games() functions",
        "CLI: python scripts/export.py progress - exports progress report from data/progress.json",
        "CLI: python scripts/export.py games - exports game summaries from data/sessions/ and data/games/",
        "Output format: markdown to stdout",
        "Progress report includes: current level, sessions completed, streak, accuracy trends, areas for improvement, SRS status",
        "Games report includes: per-game date, opponent Elo, result, accuracy, key mistakes",
        "No progress file: prints 'No progress data found. Play some games first!'",
        "No game files: prints 'No games found.'",
        "Corrupted JSON files: skip with warning",
        "python -m py_compile scripts/export.py passes",
        "python -c \"from scripts.export import export_progress, export_games\" passes"
      ],
      "priority": 12,
      "passes": false,
      "notes": "Markdown format chosen for human readability and Claude Code consumption."
    },
    {
      "id": "US-013",
      "title": "Create Claude settings and run integration verification",
      "description": "As a developer, I need .claude/settings.json for MCP server config and final integration verification.",
      "acceptanceCriteria": [
        ".claude/settings.json exists with mcpServers config",
        "MCP config: command=python, args=[mcp-server/server.py]",
        "Creates .claude/ directory if it doesn't exist",
        "Merges with existing settings.json if present (don't overwrite)",
        "python -m py_compile passes on ALL .py files in scripts/ and mcp-server/",
        "python scripts/validate_puzzles.py exits with code 0",
        "All required directories exist: data/sessions, data/games, data/lesson_plans, references/, puzzles/, mcp-server/, scripts/, .claude/",
        "All required files exist: scripts/install.sh, scripts/engine.py, scripts/srs.py, scripts/tui.py, scripts/export.py, scripts/models.py, scripts/validate_puzzles.py, mcp-server/server.py, SKILL.md"
      ],
      "priority": 13,
      "passes": false,
      "notes": "Final story - verification that all pieces are in place. Should be the last story implemented."
    }
  ]
}
